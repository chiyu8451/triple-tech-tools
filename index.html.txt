<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>å·¥ç­ç¥éšŠå‹</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { padding: 20px; background-color: #f8f9fa; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
    .loading-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255, 255, 255, 0.9); z-index: 9999;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    .hidden { display: none !important; }
  </style>
</head>
<body>

  <div id="loading" class="loading-overlay">
    <div class="spinner-border text-primary" role="status"></div>
    <div id="loading-text" class="mt-3 text-muted">ç³»çµ±é€£ç·šä¸­...</div>
  </div>

  <div class="container" id="main-app" class="hidden">
    <h4 class="mb-4 text-center" id="companyTitle">è¼‰å…¥ä¸­...</h4>
    
    <form id="workForm" onsubmit="handleSubmit(event)">
      <input type="hidden" id="userId">
      
      <div class="mb-3">
        <label class="form-label">æ—¥æœŸ</label>
        <input type="date" class="form-control" id="date" required>
      </div>

      <div class="mb-3">
        <label class="form-label">å·¥åœ°</label>
        <select class="form-select" id="site" required>
          <option value="" disabled selected>è¼‰å…¥ä¸­...</option>
        </select>
      </div>

      <div class="mb-3">
        <label class="form-label">å¸«å‚…</label>
        <select class="form-select" id="worker" required>
          <option value="" disabled selected>è¼‰å…¥ä¸­...</option>
        </select>
      </div>

      <div class="row">
        <div class="col-6 mb-3">
          <label class="form-label">å·¥æ•¸</label>
          <input type="number" class="form-control" id="count" value="1" step="0.5">
        </div>
        <div class="col-6 mb-3">
          <label class="form-label">ä¾¿ç•¶</label>
          <input type="number" class="form-control" id="bento" value="1">
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">åŠ ç­ A / B</label>
        <div class="input-group">
          <input type="number" class="form-control" id="otA" placeholder="Aæ™‚æ•¸">
          <input type="number" class="form-control" id="otB" placeholder="Bæ™‚æ•¸">
        </div>
      </div>

      <button type="submit" id="submitBtn" class="btn btn-primary w-100 btn-lg">é€å‡ºç´€éŒ„</button>
    </form>
    
    <div class="mt-3 text-center">
      <small class="text-muted" id="version-tag">Ver: GitHub Pro Edition</small>
    </div>
  </div>

<script>
  // ================= è¨­å®šå€ (è«‹ä¿®æ”¹é€™è£¡) =================
  const LIFF_ID = "2008802133-cGpq8Rq1"; // ä½ çš„ LIFF ID
  // ğŸ‘‡ æŠŠä½ å‰›å‰›åœ¨ GAS éƒ¨ç½²æ‹¿åˆ°çš„ç¶²å€è²¼åœ¨é€™è£¡
  const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxdi4l3oJCOCjIt7IsVphGhMGeE57NrZKeAzKIfavHvM2Hlb3fvNxra7bmy_Isn4F5SKA/exec"; 
  // ======================================================

  window.onload = function() {
    document.getElementById('date').valueAsDate = new Date();
    initLiff();
  };

  function initLiff() {
    liff.init({ liffId: LIFF_ID })
      .then(() => {
        if (liff.isLoggedIn()) {
          getUserProfile();
        } else {
          // æœªç™»å…¥ï¼Œç›´æ¥è·³è½‰ LINE ç™»å…¥ç•«é¢
          // å› ç‚ºç¾åœ¨æ˜¯ GitHub Pages å›ºå®šç¶²å€ï¼ŒredirectUri ä¸è¨­ä¹Ÿæ²’é—œä¿‚ï¼Œå®ƒæœƒè‡ªå·±å›ä¾†
          liff.login();
        }
      })
      .catch(err => {
        alert("LIFF åˆå§‹åŒ–å¤±æ•—: " + err);
        // é–‹ç™¼æ™‚æ–¹ä¾¿é™¤éŒ¯ï¼Œå¦‚æœ LIFF å£äº†å¯ä»¥ç”¨æ¸¬è©¦ ID
        // fetchInitData("Uada807809f80f9f961928ba8ee616953"); 
      });
  }

  function getUserProfile() {
    liff.getProfile().then(profile => {
      document.getElementById('userId').value = profile.userId;
      fetchInitData(profile.userId);
    }).catch(err => {
      alert("è®€å– User è³‡æ–™å¤±æ•—: " + err);
    });
  }

  // ğŸ”¥ æ ¸å¿ƒæŠ€è¡“ï¼šç”¨ fetch å‘¼å« GAS API
  function fetchInitData(userId) {
    updateLoading("è®€å–é›²ç«¯è³‡æ–™åº«...");
    
    const payload = {
      action: "getInitData", // å‘Šè¨´å¾Œç«¯æˆ‘è¦åšä»€éº¼
      userId: userId
    };

    // ä½¿ç”¨ POST ç™¼é€ï¼Œé¿å…ç¶²å€é•·åº¦é™åˆ¶ï¼Œä¸”å…§å®¹æ”¾ body
    fetch(GAS_API_URL, {
      method: "POST",
      body: JSON.stringify(payload)
      // æ³¨æ„ï¼šé€™è£¡ä¸è¨­ 'Content-Type': 'application/json' 
      // è€Œæ˜¯ç”¨é è¨­ text/plain å‚³é€ï¼Œé€™æ˜¯ç‚ºäº†é¿é–‹ GAS çš„ CORS é æª¢è«‹æ±‚ (Preflight)
    })
    .then(response => response.json()) // æŠŠå›å‚³çš„æ–‡å­—è½‰æˆ JSON ç‰©ä»¶
    .then(res => {
      if (res.status === "success") {
        document.getElementById('companyTitle').innerText = res.company;
        updateSelect('site', res.sites);
        updateSelect('worker', res.workers);
        hideLoading();
      } else {
        alert("ç³»çµ±éŒ¯èª¤: " + res.message);
      }
    })
    .catch(err => {
      alert("é€£ç·šå¤±æ•— (API): " + err);
    });
  }

  function handleSubmit(e) {
    e.preventDefault();
    const btn = document.getElementById('submitBtn');
    btn.disabled = true;
    btn.innerText = "å¯«å…¥ä¸­...";
    
    const formData = {
      userId: document.getElementById('userId').value,
      date: document.getElementById('date').value,
      site: document.getElementById('site').value,
      worker: document.getElementById('worker').value,
      count: document.getElementById('count').value,
      bento: document.getElementById('bento').value,
      otA: document.getElementById('otA').value,
      otB: document.getElementById('otB').value
    };

    const payload = {
      action: "submitForm",
      formData: formData
    };

    fetch(GAS_API_URL, {
      method: "POST",
      body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(res => {
      btn.disabled = false;
      btn.innerText = "é€å‡ºç´€éŒ„";
      
      if (res.status === "success") {
        alert("âœ… æˆåŠŸå¯«å…¥ï¼");
        liff.closeWindow();
      } else {
        alert("âŒ å¯«å…¥å¤±æ•—: " + res.message);
      }
    })
    .catch(err => {
      btn.disabled = false;
      btn.innerText = "é€å‡ºç´€éŒ„";
      alert("é€£ç·šä¸­æ–·: " + err);
    });
  }

  function updateSelect(id, items) {
    const sel = document.getElementById(id);
    sel.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡...</option>';
    items.forEach(item => {
      const opt = document.createElement('option');
      opt.value = item;
      opt.innerText = item;
      sel.appendChild(opt);
    });
  }

  function updateLoading(text) {
    document.getElementById('loading-text').innerText = text;
  }
  
  function hideLoading() {
    document.getElementById('loading').classList.add('hidden');
    document.getElementById('main-app').classList.remove('hidden');
  }
</script>

</body>
</html>