<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>å·¥ç­ç¥éšŠå‹</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { padding: 20px; background-color: #f8f9fa; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; padding-bottom: 80px;}
    .loading-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255, 255, 255, 0.95); z-index: 9999;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    .hidden { display: none !important; }
    .card { box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: none; }
    .list-group-item { border-left: none; border-right: none; }
  </style>
</head>
<body>

  <div id="loading" class="loading-overlay">
    <div class="spinner-border text-primary" role="status"></div>
    <div id="loading-text" class="mt-3 text-muted fw-bold">ç³»çµ±é€£ç·šä¸­...</div>
  </div>

  <div class="container hidden" id="main-app">
    <h4 class="mb-4 text-center fw-bold text-primary" id="companyTitle">è¼‰å…¥ä¸­...</h4>
    
    <div class="card p-3 mb-4">
      <form id="workForm" onsubmit="handleSubmit(event)">
        <input type="hidden" id="userId">
        
        <div class="mb-3">
          <label class="form-label fw-bold">ğŸ“… æ—¥æœŸ</label>
          <input type="date" class="form-control form-control-lg" id="date" required>
        </div>

        <div class="row">
          <div class="col-6 mb-3">
            <label class="form-label fw-bold">ğŸ—ï¸ å·¥åœ°</label>
            <select class="form-select form-select-lg" id="site" required>
              <option value="" disabled selected>...</option>
            </select>
          </div>
          <div class="col-6 mb-3">
             <label class="form-label fw-bold">ğŸ‘· å¸«å‚…</label>
            <select class="form-select form-select-lg" id="worker" required>
              <option value="" disabled selected>...</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="col-6 mb-3">
            <label class="form-label fw-bold">å·¥æ•¸</label>
            <input type="number" class="form-control" id="count" value="1" step="0.5">
          </div>
          <div class="col-6 mb-3">
            <label class="form-label fw-bold">ä¾¿ç•¶</label>
            <input type="number" class="form-control" id="bento" value="1">
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label fw-bold">åŠ ç­æ™‚æ•¸ (A / B)</label>
          <div class="input-group">
            <input type="number" class="form-control" id="otA" placeholder="A åŠ ç­">
            <input type="number" class="form-control" id="otB" placeholder="B åŠ ç­">
          </div>
        </div>

        <button type="submit" id="submitBtn" class="btn btn-primary w-100 btn-lg shadow-sm">é€å‡ºç´€éŒ„</button>
      </form>
    </div>

    <div class="card mb-3">
      <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <span class="fw-bold text-dark">ğŸ“Š æœ¬æœˆçµ±è¨ˆ (<span id="reportMonth"></span>)</span>
        <button class="btn btn-sm btn-outline-primary" onclick="loadReport()">åˆ·æ–°</button>
      </div>
      <div class="card-body p-0">
        <table class="table table-striped mb-0" style="font-size: 14px;">
          <thead>
            <tr>
              <th class="ps-3">å¸«å‚…</th>
              <th class="text-center">å·¥æ•¸</th>
              <th class="text-center">åŠ ç­(H)</th>
            </tr>
          </thead>
          <tbody id="reportBody">
            <tr><td colspan="3" class="text-center text-muted py-3">è¼‰å…¥ä¸­...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <span class="fw-bold text-dark">ğŸ•’ æœ€è¿‘ 10 ç­†æ˜ç´°</span>
        <button class="btn btn-sm btn-outline-secondary" onclick="loadHistory()">åˆ·æ–°</button>
      </div>
      <ul class="list-group list-group-flush" id="historyList" style="font-size: 14px;">
         <li class="list-group-item text-center text-muted py-3">è¼‰å…¥ä¸­...</li>
      </ul>
    </div>
    
    <div class="mt-4 text-center pb-4">
      <small class="text-muted" id="version-tag">System Ver: 3.5 (Stable)</small>
    </div>
  </div>

<script>
  // ================= è¨­å®šå€ (è«‹å‹™å¿…ä¿®æ”¹é€™è£¡) =================
  const LIFF_ID = "2008802133-cGpq8Rq1"; 
  // ğŸ‘‡ æŠŠä½ çš„ GAS API ç¶²å€è²¼åœ¨é€™è£¡ (æ³¨æ„ä¸è¦æœ‰ç©ºæ ¼)
  const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxdi4l3oJCOCjIt7IsVphGhMGeE57NrZKeAzKIfavHvM2Hlb3fvNxra7bmy_Isn4F5SKA/exec"; 
  // ========================================================

  window.onload = function() {
    document.getElementById('date').valueAsDate = new Date();
    initLiff();
  };

  function initLiff() {
    liff.init({ liffId: LIFF_ID })
      .then(() => {
        if (liff.isLoggedIn()) {
          getUserProfile();
        } else {
          liff.login();
        }
      })
      .catch(err => {
        alert("LIFF åˆå§‹åŒ–å¤±æ•—: " + err);
      });
  }

  function getUserProfile() {
    liff.getProfile().then(profile => {
      document.getElementById('userId').value = profile.userId;
      // ä¾åºè¼‰å…¥ï¼š1.é¸å–® -> 2.å ±è¡¨ -> 3.æ­·å²ç´€éŒ„
      fetchInitData(profile.userId);
      loadReport();
      loadHistory();
    }).catch(err => {
      alert("è®€å– User è³‡æ–™å¤±æ•—: " + err);
    });
  }

  // --- API 1: å–å¾—åˆå§‹åŒ–è³‡æ–™ ---
  function fetchInitData(userId) {
    updateLoading("è®€å–é›²ç«¯è³‡æ–™åº«...");
    const payload = { action: "getInitData", userId: userId };
    callApi(payload, (res) => {
      document.getElementById('companyTitle').innerText = res.company;
      updateSelect('site', res.sites);
      updateSelect('worker', res.workers);
      hideLoading();
    });
  }

  // --- API 2: é€å‡ºè¡¨å–® ---
  function handleSubmit(e) {
    e.preventDefault();
    const btn = document.getElementById('submitBtn');
    btn.disabled = true;
    btn.innerText = "è³‡æ–™å¯«å…¥ä¸­...";
    
    const formData = {
      userId: document.getElementById('userId').value,
      date: document.getElementById('date').value,
      site: document.getElementById('site').value,
      worker: document.getElementById('worker').value,
      count: document.getElementById('count').value,
      bento: document.getElementById('bento').value,
      otA: document.getElementById('otA').value,
      otB: document.getElementById('otB').value
    };

    const payload = { action: "submitForm", formData: formData };

    callApi(payload, (res) => {
      btn.disabled = false;
      btn.innerText = "é€å‡ºç´€éŒ„";
      alert("âœ… æˆåŠŸå¯«å…¥ï¼");
      // æˆåŠŸå¾Œè‡ªå‹•åˆ·æ–°å ±è¡¨èˆ‡æ˜ç´°
      loadReport();
      loadHistory();
    }, (err) => {
      btn.disabled = false;
      btn.innerText = "é€å‡ºç´€éŒ„";
      alert("âŒ å¤±æ•—: " + err);
    });
  }

  // --- API 3: å–å¾—æœˆå ±è¡¨ ---
  function loadReport() {
    const userId = document.getElementById('userId').value;
    const currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM
    document.getElementById('reportMonth').innerText = currentMonth;
    document.getElementById('reportBody').innerHTML = '<tr><td colspan="3" class="text-center text-muted py-3">æ›´æ–°æ•¸æ“šä¸­...</td></tr>';

    callApi({ action: "getMonthlyReport", userId: userId, month: currentMonth }, (res) => {
      renderReport(res.data);
    });
  }

  function renderReport(data) {
    const tbody = document.getElementById('reportBody');
    tbody.innerHTML = ""; 
    if (!data || data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted py-3">æœ¬æœˆå°šç„¡ç´€éŒ„</td></tr>';
      return;
    }
    data.forEach(item => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td class="ps-3 fw-bold">${item.name}</td><td class="text-center">${item.days}</td><td class="text-center">${item.ot}</td>`;
      tbody.appendChild(tr);
    });
  }

  // --- API 4: å–å¾—æ­·å²ç´€éŒ„ ---
  function loadHistory() {
    const userId = document.getElementById('userId').value;
    const list = document.getElementById('historyList');
    list.innerHTML = '<li class="list-group-item text-center text-muted py-3">æ›´æ–°æ•¸æ“šä¸­...</li>';

    callApi({ action: "getHistory", userId: userId }, (res) => {
      renderHistory(res.data);
    });
  }

  function renderHistory(data) {
    const list = document.getElementById('historyList');
    list.innerHTML = "";
    if (!data || data.length === 0) {
      list.innerHTML = '<li class="list-group-item text-center text-muted">å°šç„¡è³‡æ–™</li>';
      return;
    }
    data.forEach(item => {
      const li = document.createElement('li');
      li.className = "list-group-item d-flex justify-content-between align-items-center";
      li.innerHTML = `
        <div>
          <span class="badge bg-secondary me-1">${item.date.slice(5)}</span>
          <span class="fw-bold text-dark">${item.worker}</span>
          <br>
          <small class="text-muted ps-1">@${item.site}</small>
        </div>
        <div class="text-end">
          <span class="badge bg-primary rounded-pill">${item.count} å·¥</span>
          ${item.ot > 0 ? `<br><span class="badge bg-danger rounded-pill mt-1">+${item.ot}H</span>` : ''}
        </div>
      `;
      list.appendChild(li);
    });
  }

  // --- é€šç”¨ Fetch å‡½å¼ (ç°¡åŒ–ä»£ç¢¼) ---
  function callApi(payload, onSuccess, onError) {
    fetch(GAS_API_URL, {
      method: "POST",
      body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(res => {
      if (res.status === "success") {
        onSuccess(res);
      } else {
        if(onError) onError(res.message);
        else alert("ç³»çµ±è¨Šæ¯: " + res.message);
      }
    })
    .catch(err => {
      console.error(err);
      if(onError) onError("é€£ç·šå¤±æ•—");
      else alert("é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯");
    });
  }

  function updateSelect(id, items) {
    const sel = document.getElementById(id);
    sel.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡...</option>';
    items.forEach(item => {
      const opt = document.createElement('option');
      opt.value = item;
      opt.innerText = item;
      sel.appendChild(opt);
    });
  }

  function updateLoading(text) { document.getElementById('loading-text').innerText = text; }
  function hideLoading() { document.getElementById('loading').classList.add('hidden'); document.getElementById('main-app').classList.remove('hidden'); }
</script>
</body>
</html>
