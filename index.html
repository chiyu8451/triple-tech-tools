<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>å·¥ç­ç®¡ç†ç³»çµ±</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    /* === V8.0 æ¥µè‡´å·¥ç¨‹ç‰ˆ (ç„¡ Emoji, å°ˆæ¥­åœ–æ¨™) === */
    :root {
      --primary-navy: #2c3e50;
      --accent-orange: #d35400;
      --bg-grey: #e9ecef;
      --text-dark: #212529;
      --border-color: #ced4da;
    }
    body { 
      padding: 0; background-color: var(--bg-grey); 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
      padding-bottom: 100px; color: var(--text-dark); font-size: 16px;
      -webkit-tap-highlight-color: transparent;
    }

    /* é ‚éƒ¨å°èˆª */
    .nav-header { 
      background: var(--primary-navy); color: #fff; padding: 12px 15px; 
      border-bottom: 4px solid var(--accent-orange); 
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      position: sticky; top: 0; z-index: 1020;
    }
    .company-name { font-size: 1.25rem; font-weight: 700; letter-spacing: 0.5px; }
    .sub-title { font-size: 0.8rem; opacity: 0.8; }

    /* é ç±¤å„ªåŒ– - å¢å¤§è§¸æ§å€ */
    .nav-tabs { background: #fff; border-bottom: 1px solid #dee2e6; }
    .nav-link { 
      color: #6c757d; font-weight: 600; border: none; padding: 15px 0; 
      border-bottom: 4px solid transparent; font-size: 1rem; 
    }
    .nav-link.active { 
      color: var(--accent-orange); 
      border-bottom: 4px solid var(--accent-orange); 
      background: rgba(211, 84, 0, 0.05); 
    }
    .nav-link i { margin-right: 5px; font-size: 1.1rem; }

    /* å¡ç‰‡è¨­è¨ˆ */
    .card { 
      border: 1px solid #ced4da; border-radius: 6px; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
      margin-bottom: 15px; background: #fff; 
    }
    .card-header { 
      background-color: #f8f9fa; border-bottom: 1px solid #ced4da; 
      font-weight: 700; color: var(--primary-navy); padding: 12px 15px; 
      display: flex; justify-content: space-between; align-items: center;
    }

    /* è¡¨å–®å…ƒä»¶ - åŠ å¤§ */
    .form-label { font-weight: 700; font-size: 0.95rem; margin-bottom: 5px; color: #343a40; }
    .form-control, .form-select { 
      border-radius: 4px; border: 1px solid #adb5bd; padding: 12px; font-size: 1.05rem; 
    }
    .form-control:focus, .form-select:focus { border-color: var(--primary-navy); box-shadow: none; }
    
    /* è¼¸å…¥æ¡†ç¾¤çµ„ */
    .input-group-text {
      background-color: #e9ecef; border: 1px solid #adb5bd; 
      font-weight: 600; color: #495057; font-size: 0.9rem;
    }

    /* æŒ‰éˆ•å„ªåŒ– */
    .btn { border-radius: 4px; font-weight: 700; padding: 12px; font-size: 1.05rem; letter-spacing: 0.5px; }
    .btn-primary { background-color: var(--primary-navy); border-color: var(--primary-navy); }
    .btn-secondary { background-color: #6c757d; border-color: #6c757d; }
    
    /* åˆ—è¡¨å„ªåŒ– */
    .list-group-item { border: none; border-bottom: 1px solid #e9ecef; padding: 15px; }
    .list-group-item:last-child { border-bottom: none; }
    
    /* è¼‰å…¥é®ç½© */
    .loading-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(44, 62, 80, 0.98); z-index: 9999;
      display: flex; flex-direction: column; align-items: center; justify-content: center; color: white;
      transition: opacity 0.3s;
    }
    .hidden { display: none !important; opacity: 0; pointer-events: none; }
    
    /* åˆªé™¤æ™‚çš„ç‹€æ…‹ (é˜²æ‰‹æŠ–) */
    .deleting { 
      background-color: #f8d7da !important; 
      opacity: 0.6; 
      pointer-events: none; /* é–å®šé»æ“Š */
    }
    .deleting button { display: none; } /* éš±è—æŒ‰éˆ•é˜²æ­¢èª¤è§¸ */
    .deleting::after { content: "åˆªé™¤ä¸­..."; color: #dc3545; font-weight: bold; float: right; }

    /* Login Box */
    .login-container { height: 100vh; display: flex; flex-direction: column; justify-content: center; padding: 20px; background: var(--primary-navy); color: white; }
    .login-box { background: white; padding: 30px; border-radius: 6px; color: var(--text-dark); box-shadow: 0 10px 25px rgba(0,0,0,0.3); border-top: 5px solid var(--accent-orange); }
  </style>
</head>
<body>

  <div id="loading" class="loading-overlay">
    <div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status"></div>
    <div class="mt-4 fs-5 fw-bold">ç³»çµ±åŒæ­¥ä¸­...</div>
  </div>

  <div id="login-app" class="login-container hidden">
    <div class="text-center mb-4">
      <h2 class="fw-bold">å·¥ç­ç®¡ç†ç³»çµ±</h2>
      <p class="opacity-75">è«‹è¼¸å…¥è³‡è¨Šä»¥ç¶å®šæ¬Šé™</p>
    </div>
    <div class="login-box">
      <form onsubmit="handleRegister(event)">
        <div class="mb-3">
          <label class="form-label">æ‚¨çš„å§“å</label>
          <input type="text" class="form-control" id="regUserName" required>
        </div>
        <div class="mb-4">
          <label class="form-label">å…¬å¸åç¨± (éœ€å®Œå…¨ç›¸ç¬¦)</label>
          <input type="text" class="form-control" id="regCompanyName" required>
        </div>
        <button type="submit" class="btn btn-warning w-100 text-dark">å•Ÿç”¨ç³»çµ±</button>
      </form>
    </div>
    <div class="text-center mt-4 opacity-50 small">System V8.0 Pro</div>
  </div>

  <div id="main-app" class="hidden">
    <div class="nav-header d-flex justify-content-between align-items-center">
      <div>
        <div class="company-name" id="companyTitle">...</div>
        <div class="sub-title">ç¾å ´ç®¡ç†å¾Œå°</div>
      </div>
      <input type="hidden" id="userId">
    </div>

    <ul class="nav nav-tabs nav-fill sticky-top" id="myTab" role="tablist">
      <li class="nav-item">
        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#work-pane">
          <i class="bi bi-pencil-square"></i> é»å·¥å›å ±
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#advance-pane">
          <i class="bi bi-cash-coin"></i> å¸³å‹™ç®¡ç†
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#setting-pane" onclick="loadSettingsList()">
          <i class="bi bi-gear-fill"></i> è¨­å®š
        </button>
      </li>
    </ul>

    <div class="tab-content container pt-3">
      
      <div class="tab-pane fade show active" id="work-pane">
        <div class="card p-3">
          <form onsubmit="handleSubmitWork(event)">
            <div class="mb-3"><label class="form-label">æ—¥æœŸ</label><input type="date" class="form-control" id="date" required></div>
            <div class="row g-2">
              <div class="col-6 mb-3"><label class="form-label">å·¥åœ°</label><select class="form-select" id="site" required><option value="" disabled selected>è«‹é¸æ“‡</option></select></div>
              <div class="col-6 mb-3"><label class="form-label">å¸«å‚…</label><select class="form-select" id="worker" required><option value="" disabled selected>è«‹é¸æ“‡</option></select></div>
            </div>
            <div class="row g-2">
              <div class="col-6 mb-3"><label class="form-label">å·¥æ•¸ (å¤©)</label><input type="number" class="form-control" id="count" value="1" step="0.5"></div>
              <div class="col-6 mb-3"><label class="form-label">ä¾¿ç•¶ (å€‹)</label><input type="number" class="form-control" id="bento" value="0"></div>
            </div>
            <div class="mb-3">
              <label class="form-label">åŠ ç­æ™‚æ•¸ (å–®ä½ï¼šå°æ™‚)</label>
              <div class="input-group mb-2">
                <span class="input-group-text">Aæ™‚æ®µ (18-22)</span>
                <input type="number" class="form-control" id="otA" placeholder="0">
              </div>
              <div class="input-group">
                <span class="input-group-text">Bæ™‚æ®µ (22-24)</span>
                <input type="number" class="form-control" id="otB" placeholder="0">
              </div>
            </div>
            <button type="submit" class="btn btn-primary w-100 shadow-sm">
              <i class="bi bi-check-lg"></i> ç¢ºèªé€å‡º (é€£çºŒè¼¸å…¥)
            </button>
          </form>
        </div>
        
        <div class="card">
          <div class="card-header">
            <span>ä»Šæ—¥å·²ç™»è¨˜</span>
            <button class="btn btn-sm btn-outline-secondary" onclick="loadHistory()"><i class="bi bi-arrow-clockwise"></i> åˆ·æ–°</button>
          </div>
          <ul class="list-group list-group-flush" id="historyList">
            <li class="list-group-item text-center text-muted">è¼‰å…¥ä¸­...</li>
          </ul>
        </div>
      </div>

      <div class="tab-pane fade" id="advance-pane">
        <div class="card p-3" style="border-top: 4px solid #d35400;">
          <h6 class="fw-bold mb-3">æ–°å¢å¸³å‹™</h6>
          <form onsubmit="handleSubmitAdvance(event)">
            <div class="btn-group w-100 mb-3">
              <input type="radio" class="btn-check" name="advType" id="typeDebt" value="debt" checked onchange="updateAdvHint()">
              <label class="btn btn-outline-danger py-2" for="typeDebt">é æ”¯ (æ‰£éŒ¢)</label>
              <input type="radio" class="btn-check" name="advType" id="typeClaim" value="claim" onchange="updateAdvHint()">
              <label class="btn btn-outline-success py-2" for="typeClaim">è«‹æ¬¾ (çµ¦éŒ¢)</label>
            </div>
            <div class="mb-3"><label class="form-label">æ—¥æœŸ</label><input type="date" class="form-control" id="advDate" required></div>
            <div class="mb-3"><label class="form-label">å¸«å‚…</label><select class="form-select" id="advWorker" required><option value="" disabled selected>è«‹é¸æ“‡</option></select></div>
            <div class="mb-3">
              <label class="form-label">é‡‘é¡</label>
              <input type="number" class="form-control" id="advAmount" placeholder="è¼¸å…¥é‡‘é¡" required>
              <div id="advHint" class="form-text text-danger mt-1 fw-bold">å¾æœ¬æœˆè–ªè³‡æ‰£é™¤</div>
            </div>
            <div class="mb-3"><label class="form-label">å‚™è¨»</label><input type="text" class="form-control" id="advNote" placeholder="ç”¨é€”èªªæ˜"></div>
            <button type="submit" id="btnAdv" class="btn btn-secondary w-100 shadow-sm">ç¢ºèªé€å‡º</button>
          </form>
        </div>
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center"><span>æœ€è¿‘å¸³å‹™</span><button class="btn btn-sm btn-outline-secondary" onclick="loadAdvanceHistory()"><i class="bi bi-arrow-clockwise"></i></button></div>
          <ul class="list-group list-group-flush" id="advanceList"></ul>
        </div>
      </div>

      <div class="tab-pane fade" id="setting-pane">
        <div class="card p-3 mb-3">
          <h6 class="fw-bold mb-3">æ–°å¢å¸«å‚…è³‡æ–™</h6>
          <form onsubmit="handleAddWorker(event)">
            <div class="row g-2">
              <div class="col-7"><label class="form-label small">å§“å</label><input type="text" class="form-control" id="newWorkerName" required></div>
              <div class="col-5"><label class="form-label small">æ—¥è–ª</label><input type="number" class="form-control" id="newWorkerSalary" required></div>
            </div>
            <button class="btn btn-dark w-100 mt-3" type="submit">æ–°å¢å¸«å‚…</button>
          </form>
        </div>
        <div class="card p-3">
          <h6 class="fw-bold mb-3">æ–°å¢å·¥åœ°è³‡æ–™</h6>
          <form onsubmit="handleAddSite(event)">
            <div class="mb-2"><label class="form-label small">å·¥åœ°åç¨±</label><input type="text" class="form-control" id="newSiteName" required></div>
            <div class="row g-2 mb-2">
              <div class="col-6"><label class="form-label small">æ˜¯å¦ä¾›é¤</label><select class="form-select" id="newSiteMeal"><option value="æ˜¯">æœ‰ä¾›é¤</option><option value="å¦">ç„¡ä¾›é¤</option></select></div>
              <div class="col-6"><label class="form-label small">ä¾¿ç•¶å–®åƒ¹</label><input type="number" class="form-control" id="newSitePrice" placeholder="0"></div>
            </div>
            <button class="btn btn-dark w-100" type="submit">æ–°å¢å·¥åœ°</button>
          </form>
        </div>
        <div class="card">
          <div class="card-header">ç›®å‰è¨­å®šåå–®</div>
          <ul class="list-group list-group-flush" id="settingsList"><li class="list-group-item text-center text-muted">è¼‰å…¥ä¸­...</li></ul>
        </div>
      </div>
    </div> 

    <div class="container pb-3">
      <div class="card border-0 shadow-sm mt-2">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center">
            <span class="me-2 fw-bold"><i class="bi bi-bar-chart-fill"></i> æœ¬æœˆçµç®—</span>
            <input type="month" id="reportMonthPicker" class="form-control form-control-sm" style="width: 140px; border:none;" onchange="loadReport()">
          </div>
          <button class="btn btn-sm btn-outline-light" onclick="loadReport()"><i class="bi bi-arrow-clockwise"></i></button>
        </div>
        <div class="card-body p-0">
          <div id="reportContainer" class="accordion accordion-flush"><div class="p-4 text-center text-muted">è¼‰å…¥ä¸­...</div></div>
        </div>
      </div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const LIFF_ID = "2008802133-cGpq8Rq1"; 
  const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxdi4l3oJCOCjIt7IsVphGhMGeE57NrZKeAzKIfavHvM2Hlb3fvNxra7bmy_Isn4F5SKA/exec"; 
  
  const Toast = Swal.mixin({
    toast: true, position: 'top-end', showConfirmButton: false, timer: 2000,
    timerProgressBar: false, didOpen: (toast) => { toast.addEventListener('mouseenter', Swal.stopTimer); toast.addEventListener('mouseleave', Swal.resumeTimer); }
  });

  window.onload = function() {
    const today = new Date();
    document.getElementById('date').valueAsDate = today;
    document.getElementById('advDate').valueAsDate = today;
    document.getElementById('reportMonthPicker').value = today.toISOString().slice(0, 7);
    initLiff();
    updateAdvHint(); 
  };

  function initLiff() {
    liff.init({ liffId: LIFF_ID }).then(() => {
      if (liff.isLoggedIn()) getUserProfile(); else liff.login();
    }).catch(err => {
      console.error('LIFF Error:', err);
      // éœé»˜å¤±æ•—ï¼Œä¸è¦è·³è¦–çª—åš‡ä½¿ç”¨è€…ï¼Œå¯èƒ½åªæ˜¯ç¶²è·¯æ…¢
    });
  }

  function getUserProfile() {
    liff.getProfile().then(profile => {
      document.getElementById('userId').value = profile.userId;
      fetchInitData(profile.userId);
    });
  }

  function refreshAll() { loadHistory(); loadAdvanceHistory(); loadReport(); }

  // ğŸ”¥ æ ¸å¿ƒå„ªåŒ–ï¼šå¿«å–å„ªå…ˆ (Cache First Strategy)
  function fetchInitData(userId) {
    const cached = localStorage.getItem('initData_' + userId);
    
    // 1. æœ‰å¿«å–ï¼Œå…ˆé¡¯ç¤ºï¼Œ0ç§’ç­‰å¾…
    if (cached) {
      console.log("Using Cache");
      renderInitData(JSON.parse(cached));
    }
    
    // 2. èƒŒæ™¯é»˜é»˜å»æ›´æ–°ï¼Œä¸æ‰“æ“¾ä½¿ç”¨è€…
    callApi({ action: "getInitData", userId: userId }, (res) => {
      if (res.status === "unregistered") {
        document.getElementById('login-app').classList.remove('hidden');
        document.getElementById('main-app').classList.add('hidden');
        localStorage.removeItem('initData_' + userId);
      } else if (res.status === "success") {
        localStorage.setItem('initData_' + userId, JSON.stringify(res));
        // å¦‚æœé‚„æ²’é¡¯ç¤ºé (ç¬¬ä¸€æ¬¡ç”¨)ï¼Œæ‰æ¸²æŸ“ï¼Œé¿å…ä¸‹æ‹‰é¸å–®è·³æ‰
        if (!cached || document.getElementById('site').options.length <= 1) {
           renderInitData(res);
        }
      }
    }, false); // false = ä¸é¡¯ç¤º Loading
  }

  function renderInitData(res) {
    document.getElementById('loading').classList.add('hidden');
    document.getElementById('login-app').classList.add('hidden');
    document.getElementById('main-app').classList.remove('hidden');
    document.getElementById('companyTitle').innerText = res.company;
    
    // åªæœ‰ç•¶é¸å–®æ˜¯ç©ºçš„æ™‚å€™æ‰æ›´æ–°ï¼Œé¿å…çˆ¸çˆ¸é¸åˆ°ä¸€åŠè¢«é‡ç½®
    updateSelectIfEmpty('site', res.sites);
    updateSelectIfEmpty('worker', res.workers);
    updateSelectIfEmpty('advWorker', res.workers);
    
    refreshAll();
  }

  function updateSelectIfEmpty(id, items) {
    const sel = document.getElementById(id);
    if (sel.options.length <= 1) {
        sel.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡</option>';
        items.forEach(i => sel.add(new Option(i, i)));
    }
  }

  // ğŸ”¥ æ ¸å¿ƒå„ªåŒ–ï¼šAPI è‡ªå‹•é‡è©¦ (è§£æ±ºç¶²è·¯ä¸ç©©)
  function callApi(payload, onSuccess, showLoading=false, retries=3) {
    if(showLoading) Swal.fire({ title: 'è™•ç†ä¸­...', allowOutsideClick: false, didOpen: () => { Swal.showLoading() } });
    
    fetch(GAS_API_URL, { method: "POST", body: JSON.stringify(payload) })
    .then(res => res.json())
    .then(res => {
      if(showLoading) Swal.close();
      if (res.status === "success") onSuccess(res);
      else Swal.fire('éŒ¯èª¤', res.message, 'error');
    })
    .catch(err => {
      if (retries > 0) {
        console.log(`é€£ç·šå¤±æ•—ï¼Œè‡ªå‹•é‡è©¦... å‰©é¤˜æ¬¡æ•¸ ${retries}`);
        setTimeout(() => callApi(payload, onSuccess, showLoading, retries - 1), 1500);
      } else {
        if(showLoading) Swal.close();
        Swal.fire('é€£ç·šä¸ç©©', 'è«‹æª¢æŸ¥ç¶²è·¯è¨Šè™Ÿå¾Œé‡è©¦', 'error');
      }
    });
  }

  // ğŸ”¥ æ ¸å¿ƒå„ªåŒ–ï¼šé€£çºŒè¼¸å…¥æ¨¡å¼ (ä¿ç•™æ—¥æœŸèˆ‡å·¥åœ°)
  function handleSubmitWork(e) {
    e.preventDefault();
    const workerSelect = document.getElementById('worker');
    const siteSelect = document.getElementById('site');
    const workerName = workerSelect.options[workerSelect.selectedIndex].text;
    const siteName = siteSelect.options[siteSelect.selectedIndex].text;
    const count = document.getElementById('count').value;
    const dateVal = document.getElementById('date').value;
    const otA = document.getElementById('otA').value;
    const otB = document.getElementById('otB').value;

    const formData = {
      userId: document.getElementById('userId').value, date: dateVal, site: document.getElementById('site').value, worker: document.getElementById('worker').value,
      count: count, bento: document.getElementById('bento').value, otA: otA, otB: otB
    };

    // æ¨‚è§€ UI
    const list = document.getElementById('historyList');
    const tempId = 'temp-' + new Date().getTime(); 
    const dateObj = new Date(dateVal);
    const dateStr = (dateObj.getMonth()+1) + '/' + dateObj.getDate();
    
    // ç§»é™¤ "è¼‰å…¥ä¸­"
    const emptyMsg = list.querySelector('.text-muted');
    if(emptyMsg) emptyMsg.remove();

    const tempHtml = `
      <li class="list-group-item d-flex justify-content-between align-items-center new-item-flash" id="${tempId}">
        <div>
            <span class="badge bg-dark me-1">${dateStr}</span>
            <span class="fw-bold">${workerName}</span>
            <small class="text-muted d-block">${siteName}</small>
        </div>
        <div class="text-end">
          <span class="badge bg-secondary rounded-pill">${count}å·¥</span>
          <div class="text-success small fw-bold">å„²å­˜ä¸­...</div>
        </div>
      </li>`;
    list.insertAdjacentHTML('afterbegin', tempHtml);
    Toast.fire({ icon: 'success', title: 'å·²åŠ å…¥' });

    // åªæ¸…ç©ºå¸«å‚…ç›¸é—œï¼Œä¿ç•™æ—¥æœŸèˆ‡å·¥åœ°
    document.getElementById('worker').value = ""; 
    document.getElementById('count').value = "1"; 
    document.getElementById('bento').value = "0"; 
    document.getElementById('otA').value = "";
    document.getElementById('otB').value = "";

    callApi({ action: "submitForm", formData: formData }, (res) => {
       // èƒŒæ™¯å·å·åˆ·æ–°ï¼Œå°‡æš«å­˜è½‰ç‚ºæ­£å¼ ID
       loadHistory(true); 
    }, false);
  }

  // ğŸ”¥ æ ¸å¿ƒå„ªåŒ–ï¼šåˆªé™¤é˜²æ‰‹æŠ– (Anti-Misclick)
  function deleteItem(action, rowIndex, elementId, desc) {
    Swal.fire({
      title: 'ç¢ºå®šåˆªé™¤ï¼Ÿ',
      html: `<div class="alert alert-light text-start border">${desc}</div>`,
      icon: 'warning',
      showCancelButton: true, confirmButtonText: 'ç¢ºèªåˆªé™¤', cancelButtonText: 'å–æ¶ˆ',
      confirmButtonColor: '#dc3545', cancelButtonColor: '#6c757d',
      focusCancel: true // é è¨­èšç„¦åœ¨å–æ¶ˆï¼Œé˜²æ­¢é€£é»
    }).then((result) => {
      if (result.isConfirmed) {
        const row = document.getElementById(elementId);
        if(row) {
            row.classList.add('deleting'); // è®Šç°ä¸¦é–å®š
        }
        callApi({ action: action, userId: document.getElementById('userId').value, rowIndex: rowIndex }, (res) => { 
            if(row) row.remove();
            loadReport(); 
        }, false);
      }
    });
  }

  function loadHistory(silent = false) {
    const list = document.getElementById('historyList');
    if(!silent) list.innerHTML = '<li class="list-group-item text-center text-muted">è¼‰å…¥ä¸­...</li>';
    
    fetch(GAS_API_URL, { method: "POST", body: JSON.stringify({ action: "getHistory", userId: document.getElementById('userId').value }) })
    .then(res => res.json())
    .then(res => {
      if (res.status === "success") {
        list.innerHTML = "";
        if (!res.data || res.data.length === 0) { list.innerHTML = '<li class="list-group-item text-center text-muted">ä»Šæ—¥å°šç„¡è³‡æ–™</li>'; return; }
        res.data.forEach((item) => {
          const uniqueId = `hist-${item.rowIndex}`; 
          const desc = `<strong>${item.worker}</strong><br>${item.date} @ ${item.site} (${item.count}å·¥)`;
          list.innerHTML += `
            <li class="list-group-item d-flex justify-content-between align-items-center" id="${uniqueId}">
              <div><span class="badge bg-dark me-1">${item.date}</span><span class="fw-bold">${item.worker}</span><small class="text-muted d-block">${item.site}</small></div>
              <div class="text-end"><span class="badge bg-secondary rounded-pill">${item.count}å·¥</span>
              <button class="btn btn-sm btn-outline-danger ms-2" onclick="deleteItem('deleteRecord', ${item.rowIndex}, '${uniqueId}', '${desc}')"><i class="bi bi-trash"></i> åˆªé™¤</button></div>
            </li>`;
        });
      }
    });
  }

  // å…¶ä»–å‡½å¼ç¶­æŒæ¨™æº–åŒ–
  function handleSubmitAdvance(e) { e.preventDefault(); const isDebt = document.getElementById('typeDebt').checked; let amount = Number(document.getElementById('advAmount').value); if (!isDebt) amount = -amount; const formData = { userId: document.getElementById('userId').value, worker: document.getElementById('advWorker').value, date: document.getElementById('advDate').value, amount: amount, note: document.getElementById('advNote').value }; callApi({ action: "submitAdvance", formData: formData }, (res) => { Swal.fire({icon: 'success', title: 'å¸³å‹™å·²ç´€éŒ„', timer: 1500, showConfirmButton: false}); document.getElementById('advAmount').value = ""; document.getElementById('advNote').value = ""; refreshAll(); }, true); }
  function loadAdvanceHistory() { callApi({ action: "getAdvanceHistory", userId: document.getElementById('userId').value }, (res) => { const list = document.getElementById('advanceList'); list.innerHTML = ""; if (!res.data || res.data.length === 0) { list.innerHTML = '<li class="list-group-item text-center text-muted">å°šç„¡è³‡æ–™</li>'; return; } res.data.forEach((item) => { const uniqueId = `adv-${item.rowIndex}`; let colorClass = item.amount > 0 ? "text-danger" : "text-success"; let displayAmount = item.amount > 0 ? `-${fmt(item.amount)}` : `+${fmt(Math.abs(item.amount))}`; const desc = `${item.date} ${item.worker} $${item.amount}`; list.innerHTML += `<li class="list-group-item d-flex justify-content-between align-items-center" id="${uniqueId}"><div><span class="badge bg-light text-dark border me-1">${item.date}</span><span class="fw-bold ${colorClass}">${item.worker}</span><small class="text-muted d-block">${item.note}</small></div><div class="text-end"><span class="${colorClass} fw-bold money-text">${displayAmount}</span><button class="btn btn-sm btn-outline-danger ms-2" onclick="deleteItem('deleteAdvance', ${item.rowIndex}, '${uniqueId}', '${desc}')"><i class="bi bi-trash"></i></button></div></li>`; }); }, false); }
  function handleRegister(e) { e.preventDefault(); const name = document.getElementById('regUserName').value; const company = document.getElementById('regCompanyName').value; const userId = document.getElementById('userId').value; Swal.fire({ title: 'ç¶å®šä¸­...', text: 'æ­£åœ¨å°‹æ‰¾è³‡æ–™åº«', allowOutsideClick: false, didOpen: () => Swal.showLoading() }); fetch(GAS_API_URL, { method: "POST", body: JSON.stringify({ action: "registerUser", userId: userId, userName: name, companyName: company }) }).then(res => res.json()).then(res => { if (res.status === "success") { Swal.fire('æˆåŠŸ', 'ç¶å®šå®Œæˆ', 'success').then(() => location.reload()); } else { Swal.fire('ç¶å®šå¤±æ•—', res.message, 'error'); } }); }
  function loadSettingsList() { const list = document.getElementById('settingsList'); list.innerHTML = '<li class="list-group-item text-center text-muted">è¼‰å…¥ä¸­...</li>'; callApi({ action: "getSettingsList", userId: document.getElementById('userId').value }, (res) => { list.innerHTML = ""; list.innerHTML += `<li class="list-group-item bg-light fw-bold small">å¸«å‚…åå–®</li>`; res.data.workers.forEach(w => list.innerHTML += `<li class="list-group-item d-flex justify-content-between"><span>${w.name} ($${w.salary})</span><button class="btn btn-sm btn-outline-secondary" onclick="deleteSetting('worker', ${w.rowIndex})">ç§»é™¤</button></li>`); list.innerHTML += `<li class="list-group-item bg-light fw-bold small mt-2">å·¥åœ°åå–®</li>`; res.data.sites.forEach(s => list.innerHTML += `<li class="list-group-item d-flex justify-content-between"><span>${s.name}</span><button class="btn btn-sm btn-outline-secondary" onclick="deleteSetting('site', ${s.rowIndex})">ç§»é™¤</button></li>`); }, false); }
  function handleAddWorker(e) { e.preventDefault(); const name = document.getElementById('newWorkerName').value; const salary = document.getElementById('newWorkerSalary').value; callApi({ action: "addSetting", formData: { userId: document.getElementById('userId').value, type: 'worker', name: name, salary: salary } }, (res) => { Swal.fire('æˆåŠŸ', 'å¸«å‚…å·²æ–°å¢', 'success'); document.getElementById('newWorkerName').value = ""; document.getElementById('newWorkerSalary').value = ""; loadSettingsList(); localStorage.removeItem('initData_' + document.getElementById('userId').value); }, true); }
  function handleAddSite(e) { e.preventDefault(); const name = document.getElementById('newSiteName').value; const hasMeal = document.getElementById('newSiteMeal').value; const price = document.getElementById('newSitePrice').value; callApi({ action: "addSetting", formData: { userId: document.getElementById('userId').value, type: 'site', name: name, hasMeal: hasMeal, mealPrice: price } }, (res) => { Swal.fire('æˆåŠŸ', 'å·¥åœ°å·²æ–°å¢', 'success'); document.getElementById('newSiteName').value = ""; loadSettingsList(); localStorage.removeItem('initData_' + document.getElementById('userId').value); }, true); }
  function deleteSetting(type, rowIndex) { Swal.fire({ title: 'ç¢ºå®šç§»é™¤ï¼Ÿ', icon: 'warning', showCancelButton: true }).then((r) => { if(r.isConfirmed) { callApi({ action: "deleteSetting", userId: document.getElementById('userId').value, type: type, rowIndex: rowIndex }, () => { Swal.fire('å·²ç§»é™¤', '', 'success'); loadSettingsList(); localStorage.removeItem('initData_' + document.getElementById('userId').value); }, true); } }); }
  function loadReport() { const userId = document.getElementById('userId').value; const picker = document.getElementById('reportMonthPicker'); const container = document.getElementById('reportContainer'); if(!picker.value) picker.value = new Date().toISOString().slice(0, 7); callApi({ action: "getMonthlyReport", userId: userId, month: picker.value }, (res) => { container.innerHTML = ""; if (!res.data || res.data.length === 0) { container.innerHTML = '<div class="p-3 text-center text-muted">æœ¬æœˆå°šç„¡è³‡æ–™</div>'; return; } res.data.forEach((w, index) => { let siteStr = Object.entries(w.sites).map(([site, days]) => `${site}: ${days}å¤©`).join(' / '); if(!siteStr) siteStr = "--"; let advDisplay = w.advances > 0 ? `<span class="text-danger">-$${fmt(w.advances)}</span>` : (w.advances < 0 ? `<span class="text-success">+$${fmt(Math.abs(w.advances))}</span>` : `<span>$0</span>`); container.innerHTML += `<div class="accordion-item"><h2 class="accordion-header" id="heading${index}"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${index}"><div class="d-flex w-100 justify-content-between me-2"><span class="fw-bold text-dark">${w.name}</span><span class="money-text text-primary">$${fmt(w.netPay)}</span></div></button></h2><div id="collapse${index}" class="accordion-collapse collapse" data-bs-parent="#reportContainer"><div class="accordion-body bg-light"><ul class="list-unstyled mb-0" style="font-size: 14px;"><li class="mb-2"><strong>å·¥åœ°åˆ†ä½ˆï¼š</strong><br>${siteStr}</li><li class="d-flex justify-content-between"><span>æ­£å¸¸å·¥æ•¸ï¼š</span><span>${w.totalDays} å·¥</span></li><li class="d-flex justify-content-between"><span>åŠ ç­æ™‚æ•¸ï¼š</span><span>A:${w.totalOtA} / B:${w.totalOtB}</span></li><li class="d-flex justify-content-between text-secondary"><span>æ‡‰ä»˜å ±é…¬ï¼š</span><span>$${fmt(w.grossPay)}</span></li><li class="d-flex justify-content-between border-bottom pb-2 mb-2"><span>å¸³å‹™èª¿æ•´ï¼š</span>${advDisplay}</li><li class="d-flex justify-content-between fw-bold fs-5 text-dark"><span>å¯¦ä»˜é‡‘é¡ï¼š</span><span>$${fmt(w.netPay)}</span></li></ul></div></div></div>`; }); }, false); }
  function fmt(num) { return new Intl.NumberFormat('zh-TW').format(num); }
  function updateSelect(id, items) { const sel = document.getElementById(id); sel.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡</option>'; items.forEach(i => sel.add(new Option(i, i))); }
  function updateAdvHint() { const isDebt = document.getElementById('typeDebt').checked; const hint = document.getElementById('advHint'); const btn = document.getElementById('btnAdv'); if (isDebt) { hint.innerText = "å¾æœ¬æœˆè–ªè³‡æ‰£é™¤"; hint.className = "form-text text-danger mt-1 fw-bold"; btn.className = "btn btn-secondary w-100 shadow-sm"; btn.innerText = "ç¢ºèªé æ”¯ (æ‰£æ¬¾)"; } else { hint.innerText = "è£œè²¼çµ¦å¸«å‚… (ä»£å¢Šæ¬¾ç­‰)"; hint.className = "form-text text-success mt-1 fw-bold"; btn.className = "btn btn-secondary w-100 shadow-sm"; btn.innerText = "ç¢ºèªè«‹æ¬¾ (çµ¦ä»˜)"; } }
</script>
</body>
</html>
