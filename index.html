<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>å·¥ç­ç¥éšŠå‹ Pro</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    /* === å·¥æ¥­é¢¨é…è‰²ä¸»é¡Œ === */
    :root {
      --primary-navy: #2c3e50;    /* æ·±è—ï¼šå°ˆæ¥­ */
      --accent-orange: #d35400;   /* æ·±æ©˜ï¼šå·¥ç¨‹/é‡é» */
      --bg-beige: #fdfbf7;        /* ç±³ç™½ï¼šç´™å¼µæ„Ÿ */
      --text-grey: #585858;       /* æ·±ç°ï¼šå…§æ–‡ */
      --border-color: #e0e0e0;
    }

    body { 
      padding: 0; 
      background-color: var(--bg-beige); 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
      padding-bottom: 80px;
      color: var(--primary-navy);
    }
    
    /* é ‚éƒ¨å°èˆª */
    .nav-header {
      background: var(--primary-navy);
      color: #fff;
      padding: 15px 20px;
      border-bottom: 4px solid var(--accent-orange);
    }

    /* åˆ†é æŒ‰éˆ• */
    .nav-tabs {
      border-bottom: 2px solid var(--border-color);
      background: #fff;
    }
    .nav-link {
      color: var(--text-grey);
      font-weight: 600;
      border: none;
      padding: 12px 0;
      margin-bottom: -2px;
      border-bottom: 4px solid transparent;
    }
    .nav-link.active {
      color: var(--accent-orange);
      background: transparent;
      border-bottom: 4px solid var(--accent-orange);
    }
    .nav-link:hover { border-color: transparent; }

    /* å¡ç‰‡æ¨£å¼ */
    .card { 
      border: 1px solid var(--border-color); 
      border-radius: 8px; 
      box-shadow: 0 2px 6px rgba(0,0,0,0.05); 
      margin-bottom: 15px;
      background: #fff;
    }
    .card-header {
      background-color: #f8f9fa;
      border-bottom: 1px solid var(--border-color);
      font-weight: bold;
      color: var(--primary-navy);
    }

    /* æŒ‰éˆ•å„ªåŒ– */
    .btn-primary {
      background-color: var(--primary-navy);
      border-color: var(--primary-navy);
    }
    .btn-orange {
      background-color: var(--accent-orange);
      border-color: var(--accent-orange);
      color: white;
    }
    .btn-orange:hover, .btn-orange:active {
      background-color: #b34500;
      color: white;
    }

    /* å ±è¡¨æ•¸å­— */
    .money-text { font-family: 'Consolas', monospace; font-weight: bold; }
    .text-plus { color: #198754; } /* ç¶ è‰²ï¼šæ”¶å…¥ */
    .text-minus { color: #dc3545; } /* ç´…è‰²ï¼šæ”¯å‡º */

    .loading-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(44, 62, 80, 0.95); z-index: 9999;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      color: white;
    }
    .hidden { display: none !important; }
  </style>
</head>
<body>

  <div id="loading" class="loading-overlay">
    <div class="spinner-border text-light" role="status"></div>
    <div class="mt-3 fw-bold">å·¥ç­ç¥éšŠå‹ å•Ÿå‹•ä¸­...</div>
  </div>

  <div class="hidden" id="main-app">
    
    <div class="nav-header d-flex justify-content-between align-items-center">
      <div>
        <h5 class="mb-0 fw-bold" id="companyTitle">è¼‰å…¥ä¸­...</h5>
        <small style="opacity: 0.8">è€é—†æ§ç›¤ä¸­å¿ƒ V4.0</small>
      </div>
      <input type="hidden" id="userId">
    </div>

    <ul class="nav nav-tabs nav-fill sticky-top" id="myTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="work-tab" data-bs-toggle="tab" data-bs-target="#work-pane" type="button">ğŸ“ é»å·¥å›å ±</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="advance-tab" data-bs-toggle="tab" data-bs-target="#advance-pane" type="button">ğŸ’¸ å€Ÿæ”¯ç®¡ç†</button>
      </li>
    </ul>

    <div class="tab-content container pt-3">
      
      <div class="tab-pane fade show active" id="work-pane" role="tabpanel">
        
        <div class="card p-3">
          <form onsubmit="handleSubmitWork(event)">
            <div class="mb-3">
              <label class="form-label fw-bold text-secondary">æ—¥æœŸ</label>
              <input type="date" class="form-control" id="date" required>
            </div>
            <div class="row g-2">
              <div class="col-6 mb-3">
                <label class="form-label fw-bold text-secondary">å·¥åœ°</label>
                <select class="form-select" id="site" required><option value="" disabled selected>...</option></select>
              </div>
              <div class="col-6 mb-3">
                <label class="form-label fw-bold text-secondary">å¸«å‚…</label>
                <select class="form-select" id="worker" required><option value="" disabled selected>...</option></select>
              </div>
            </div>
            <div class="row g-2">
              <div class="col-6 mb-3">
                <label class="form-label fw-bold text-secondary">å·¥æ•¸</label>
                <input type="number" class="form-control" id="count" value="1" step="0.5">
              </div>
              <div class="col-6 mb-3">
                <label class="form-label fw-bold text-secondary">ä¾¿ç•¶</label>
                <input type="number" class="form-control" id="bento" value="1">
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label fw-bold text-secondary">åŠ ç­ (A / B)</label>
              <div class="input-group">
                <input type="number" class="form-control" id="otA" placeholder="Aå¹³æ—¥">
                <input type="number" class="form-control" id="otB" placeholder="Bå‡æ—¥">
              </div>
            </div>
            <button type="submit" id="btnWork" class="btn btn-primary w-100 py-2 fw-bold shadow-sm">é€å‡ºé»å·¥</button>
          </form>
        </div>

        <div class="card">
          <div class="card-header d-flex justify-content-between">
            <span>æœ€è¿‘é»å·¥</span>
            <button class="btn btn-sm btn-link text-decoration-none p-0" onclick="loadHistory()">ğŸ”„</button>
          </div>
          <ul class="list-group list-group-flush" id="historyList"></ul>
        </div>
      </div>

      <div class="tab-pane fade" id="advance-pane" role="tabpanel">
        
        <div class="card p-3 border-danger" style="border-left: 4px solid #dc3545;">
          <h6 class="text-danger fw-bold mb-3">ğŸ’° æ–°å¢é æ”¯ç´€éŒ„</h6>
          <form onsubmit="handleSubmitAdvance(event)">
            <div class="mb-3">
              <label class="form-label fw-bold text-secondary">æ—¥æœŸ</label>
              <input type="date" class="form-control" id="advDate" required>
            </div>
            <div class="row g-2">
              <div class="col-7 mb-3">
                <label class="form-label fw-bold text-secondary">å¸«å‚…</label>
                <select class="form-select" id="advWorker" required><option value="" disabled selected>...</option></select>
              </div>
              <div class="col-5 mb-3">
                <label class="form-label fw-bold text-secondary">é‡‘é¡</label>
                <input type="number" class="form-control" id="advAmount" placeholder="$" required>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label fw-bold text-secondary">å‚™è¨» (ç”¨é€”)</label>
              <input type="text" class="form-control" id="advNote" placeholder="ä¾‹å¦‚ï¼šä¿®è»Šã€ç”Ÿæ´»è²»">
            </div>
            <button type="submit" id="btnAdv" class="btn btn-orange w-100 py-2 fw-bold shadow-sm">ç¢ºèªå€Ÿæ”¯</button>
          </form>
        </div>

        <div class="card">
          <div class="card-header d-flex justify-content-between">
            <span>æœ€è¿‘å€Ÿæ”¯</span>
            <button class="btn btn-sm btn-link text-decoration-none p-0" onclick="loadAdvanceHistory()">ğŸ”„</button>
          </div>
          <ul class="list-group list-group-flush" id="advanceList"></ul>
        </div>
      </div>

    </div> <div class="container pb-3">
      <div class="card border-0 shadow-sm mt-2">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
          <span>ğŸ“Š æœ¬æœˆå ±é…¬çµç®— (<span id="reportMonth"></span>)</span>
          <button class="btn btn-sm btn-outline-light" onclick="loadReport()">åˆ·æ–°</button>
        </div>
        <div class="card-body p-0">
          <div id="reportContainer" class="accordion accordion-flush">
             <div class="p-4 text-center text-muted">è¼‰å…¥æ•¸æ“šä¸­...</div>
          </div>
        </div>
      </div>
    </div>

  </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // ================= è¨­å®šå€ =================
  const LIFF_ID = "2008802133-cGpq8Rq1"; 
  // ğŸ‘‡ æ›´æ–°ä½ çš„ GAS API ç¶²å€
  const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxdi4l3oJCOCjIt7IsVphGhMGeE57NrZKeAzKIfavHvM2Hlb3fvNxra7bmy_Isn4F5SKA/exec"; 
  // =========================================

  window.onload = function() {
    const today = new Date();
    document.getElementById('date').valueAsDate = today;
    document.getElementById('advDate').valueAsDate = today;
    initLiff();
  };

  function initLiff() {
    liff.init({ liffId: LIFF_ID })
      .then(() => {
        if (liff.isLoggedIn()) getUserProfile();
        else liff.login();
      })
      .catch(err => alert("LIFF Error: " + err));
  }

  function getUserProfile() {
    liff.getProfile().then(profile => {
      document.getElementById('userId').value = profile.userId;
      fetchInitData(profile.userId);
      refreshAll();
    });
  }

  function refreshAll() {
    loadHistory();
    loadAdvanceHistory();
    loadReport();
  }

  // --- API æ ¸å¿ƒ ---
  function callApi(payload, onSuccess) {
    fetch(GAS_API_URL, { method: "POST", body: JSON.stringify(payload) })
    .then(res => res.json())
    .then(res => {
      if (res.status === "success") onSuccess(res);
      else alert("âš ï¸ éŒ¯èª¤: " + res.message);
    })
    .catch(err => alert("âŒ é€£ç·šå¤±æ•—"));
  }

  // --- 1. åˆå§‹åŒ– ---
  function fetchInitData(userId) {
    callApi({ action: "getInitData", userId: userId }, (res) => {
      document.getElementById('companyTitle').innerText = res.company;
      updateSelect('site', res.sites);
      updateSelect('worker', res.workers);
      updateSelect('advWorker', res.workers); // å€Ÿæ”¯é é¢ä¹Ÿè¦æ›´æ–°
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('main-app').classList.remove('hidden');
    });
  }

  // --- 2. é€å‡ºé»å·¥ ---
  function handleSubmitWork(e) {
    e.preventDefault();
    const btn = document.getElementById('btnWork');
    btn.disabled = true; btn.innerText = "å¯«å…¥ä¸­...";
    
    const formData = {
      userId: document.getElementById('userId').value,
      date: document.getElementById('date').value,
      site: document.getElementById('site').value,
      worker: document.getElementById('worker').value,
      count: document.getElementById('count').value,
      bento: document.getElementById('bento').value,
      otA: document.getElementById('otA').value,
      otB: document.getElementById('otB').value
    };

    callApi({ action: "submitForm", formData: formData }, (res) => {
      alert("âœ… é»å·¥å·²ç´€éŒ„");
      btn.disabled = false; btn.innerText = "é€å‡ºé»å·¥";
      refreshAll();
    });
  }

  // --- 3. é€å‡ºå€Ÿæ”¯ ---
  function handleSubmitAdvance(e) {
    e.preventDefault();
    const btn = document.getElementById('btnAdv');
    btn.disabled = true; btn.innerText = "å¯«å…¥ä¸­...";

    const formData = {
      worker: document.getElementById('advWorker').value,
      date: document.getElementById('advDate').value,
      amount: document.getElementById('advAmount').value,
      note: document.getElementById('advNote').value
    };

    callApi({ action: "submitAdvance", formData: formData }, (res) => {
      alert("ğŸ’° å€Ÿæ”¯å·²ç´€éŒ„");
      btn.disabled = false; btn.innerText = "ç¢ºèªå€Ÿæ”¯";
      document.getElementById('advAmount').value = ""; // æ¸…ç©ºé‡‘é¡
      document.getElementById('advNote').value = "";
      refreshAll();
    });
  }

  // --- 4. é»å·¥æ­·å² ---
  function loadHistory() {
    const list = document.getElementById('historyList');
    callApi({ action: "getHistory", userId: document.getElementById('userId').value }, (res) => {
      list.innerHTML = "";
      if (!res.data || res.data.length === 0) { list.innerHTML = '<li class="list-group-item text-center text-muted">ç„¡è³‡æ–™</li>'; return; }
      
      res.data.forEach(item => {
        list.innerHTML += `
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <span class="badge bg-dark me-1">${item.date}</span>
              <span class="fw-bold">${item.worker}</span>
              <small class="text-muted d-block">@${item.site}</small>
            </div>
            <div class="text-end">
              <span class="badge bg-primary rounded-pill">${item.count}å·¥</span>
              <button class="btn btn-sm btn-outline-danger ms-2" onclick="deleteItem('deleteRecord', ${item.rowIndex})">Ã—</button>
            </div>
          </li>`;
      });
    });
  }

  // --- 5. å€Ÿæ”¯æ­·å² ---
  function loadAdvanceHistory() {
    const list = document.getElementById('advanceList');
    const userId = document.getElementById('userId').value;
    callApi({ action: "getAdvanceHistory", userId: userId }, (res) => {
      list.innerHTML = "";
      if (!res.data || res.data.length === 0) { list.innerHTML = '<li class="list-group-item text-center text-muted">ç„¡è³‡æ–™</li>'; return; }
      
      res.data.forEach(item => {
        list.innerHTML += `
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <span class="badge bg-secondary me-1">${item.date}</span>
              <span class="fw-bold text-danger">${item.worker}</span>
              <small class="text-muted d-block">${item.note}</small>
            </div>
            <div class="text-end">
              <span class="text-danger fw-bold money-text">-$${fmt(item.amount)}</span>
              <button class="btn btn-sm btn-outline-danger ms-2" onclick="deleteItem('deleteAdvance', ${item.rowIndex})">Ã—</button>
            </div>
          </li>`;
      });
    });
  }

  // --- 6. é€šç”¨åˆªé™¤ ---
  function deleteItem(action, rowIndex) {
    if(!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) return;
    callApi({ action: action, userId: document.getElementById('userId').value, rowIndex: rowIndex }, (res) => {
      alert("å·²åˆªé™¤");
      refreshAll();
    });
  }

  // --- 7. è¶…ç´šå ±è¡¨æ¸²æŸ“ ---
  function loadReport() {
    const userId = document.getElementById('userId').value;
    const currentMonth = new Date().toISOString().slice(0, 7);
    document.getElementById('reportMonth').innerText = currentMonth;
    const container = document.getElementById('reportContainer');

    callApi({ action: "getMonthlyReport", userId: userId, month: currentMonth }, (res) => {
      container.innerHTML = "";
      if (!res.data || res.data.length === 0) { container.innerHTML = '<div class="p-3 text-center text-muted">æœ¬æœˆå°šç„¡è³‡æ–™</div>'; return; }

      res.data.forEach((w, index) => {
        // ç”¢ç”Ÿå·¥åœ°åˆ†é¡å­—ä¸²
        let siteStr = Object.entries(w.sites).map(([site, days]) => `${site}: ${days}å¤©`).join(' / ');
        if(!siteStr) siteStr = "ç„¡é»å·¥ç´€éŒ„";

        // ç”¢ç”Ÿæ‰‹é¢¨ç´å¡ç‰‡
        const html = `
          <div class="accordion-item">
            <h2 class="accordion-header" id="heading${index}">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${index}">
                <div class="d-flex w-100 justify-content-between me-2">
                  <span class="fw-bold text-dark">${w.name}</span>
                  <span class="money-text text-primary">$${fmt(w.netPay)}</span>
                </div>
              </button>
            </h2>
            <div id="collapse${index}" class="accordion-collapse collapse" data-bs-parent="#reportContainer">
              <div class="accordion-body bg-light">
                <ul class="list-unstyled mb-0" style="font-size: 14px;">
                  <li class="mb-2"><strong>ğŸ—ï¸ å·¥åœ°åˆ†ä½ˆï¼š</strong><br>${siteStr}</li>
                  <li class="d-flex justify-content-between"><span>æ­£å¸¸å·¥æ•¸ï¼š</span><span>${w.totalDays} å·¥</span></li>
                  <li class="d-flex justify-content-between"><span>åŠ ç­æ™‚æ•¸ï¼š</span><span>A:${w.totalOtA} / B:${w.totalOtB}</span></li>
                  <li class="d-flex justify-content-between text-success"><span>æ‡‰ä»˜å ±é…¬ï¼š</span><span>+$${fmt(w.grossPay)}</span></li>
                  <li class="d-flex justify-content-between text-danger border-bottom pb-2 mb-2"><span>å€Ÿæ”¯æ‰£æ¬¾ï¼š</span><span>-$${fmt(w.advances)}</span></li>
                  <li class="d-flex justify-content-between fw-bold fs-5 text-dark"><span>å¯¦ä»˜é‡‘é¡ï¼š</span><span>$${fmt(w.netPay)}</span></li>
                </ul>
              </div>
            </div>
          </div>
        `;
        container.innerHTML += html;
      });
    });
  }

  // Helper: åƒåˆ†ä½
  function fmt(num) { return new Intl.NumberFormat('zh-TW').format(num); }
  function updateSelect(id, items) {
    const sel = document.getElementById(id);
    sel.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡</option>';
    items.forEach(i => sel.add(new Option(i, i)));
  }
</script>
</body>
</html>

